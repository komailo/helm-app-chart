name: Build Helm Chart

on:
    push:
        branches: [main, master]
    pull_request:

jobs:
    build:
        name: Lint, package, and publish chart
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Set up Helm
              uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
              with:
                  version: v3.12.0

            - name: Show helm version
              run: helm version --short

            - name: Update chart dependencies (if any)
              run: |
                  helm dependency update . || true

            - name: Helm lint
              run: helm lint . --values values.yaml

            - name: Helm template (render manifests)
              run: helm template . --values values.yaml > rendered.yaml

            - name: Package chart
              run: |
                  mkdir -p packaged
                  helm package . --destination packaged

            - name: Log in to GitHub Container Registry
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "${GH_TOKEN}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

            - name: Push chart to GitHub Packages (OCI)
              run: |
                  for chart in packaged/*.tgz; do
                      helm push "$chart" oci://ghcr.io/${{ github.repository_owner }}/helm
                  done
