name: Build Helm Chart

on:
    push:
        branches: [main, master]
    pull_request:

jobs:
    build:
        name: Lint, package, and publish chart
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Set up Helm
              uses: azure/setup-helm@18bc76811624f360dbd7f18c2d4ecb32c7b87bab # v1
              with:
                  version: v3.12.0

            - name: Show helm version
              run: helm version --short

            - name: Update chart dependencies (if any)
              run: |
                  helm dependency update . || true

            - name: Helm lint
              run: helm lint . --values values.yaml

            - name: Helm template (render manifests)
              run: helm template . --values values.yaml > rendered.yaml

            - name: Package chart
              run: |
                  mkdir -p packaged
                  helm package . --destination packaged

            - name: Log in to GitHub Container Registry
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "${GH_TOKEN}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

            - name: Push chart to GitHub Packages (OCI)
              run: |
                  for chart in packaged/*.tgz; do
                      helm push "$chart" oci://ghcr.io/${{ github.repository_owner }}/helm
                  done
