name: Build Helm Chart

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  build:
    name: Lint, package, and publish chart
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      CHARTS: "app-chart meta-app-chart"
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
        with:
          version: v3.12.0

      - name: Show helm version
        run: helm version --short

      - name: Update chart dependencies (if any)
        run: |
          set -euo pipefail
          for chart in $CHARTS; do
              (cd "$chart" && helm dependency update .)
          done

      - name: Helm lint
        run: |
          set -euo pipefail
          for chart in $CHARTS; do
              (cd "$chart" && helm lint . --values values.yaml)
          done

      - name: Helm template (render manifests)
        run: |
          set -euo pipefail
          mkdir -p rendered
          for chart in $CHARTS; do
              (cd "$chart" && helm template . --values values.yaml) > "rendered/${chart}.yaml"
          done

      - name: Package charts
        run: |
          set -euo pipefail
          mkdir -p packaged
          for chart in $CHARTS; do
              helm package "$chart" --destination packaged
          done

      - name: Log in to GitHub Container Registry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GH_TOKEN}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

      - name: Push chart to GitHub Packages (OCI)
        run: |
          for chart in packaged/*.tgz; do
              helm push "$chart" oci://ghcr.io/${{ github.repository_owner }}/helm
          done
