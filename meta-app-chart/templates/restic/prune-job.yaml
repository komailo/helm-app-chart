{{- if .Values.resticBackup.enabled }}
{{- $restic := .Values.resticBackup }}
{{- $cachePVCName := required "resticBackup.cachePVC.name is required when resticBackup.enabled" $restic.cachePVC.name }}
{{- $configMapName := default "restic-backup" $restic.configMapName }}
{{- $secretName := default $configMapName $restic.secretName }}
{{- $hostname := default .Release.Namespace $restic.hostname }}
{{- $retryLock := default "15m" $restic.retryLock }}
{{- $jobDefaults := dict "cachePVCName" $cachePVCName "envSecretName" $secretName "configMapName" $configMapName }}
{{- $newline := "\n" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $configMapName }}
  namespace: {{ .Release.Namespace }}
data:
  RETRY_LOCK: {{ $retryLock | quote }}
  HOSTNAME: {{ $hostname | quote }}

# Restic Prune Job
{{ $pruneJob := default (dict) $restic.pruneJob -}}
{{ include "library-app-chart.restic.cronJob" (dict "root" . "job" $pruneJob) }}

# Restic Check Job
{{ $checkJob := default (dict) $restic.checkJob -}}
{{ include "library-app-chart.restic.cronJob" (dict "root" . "job" $checkJob) }}

# Restic Init Job
{{ $initJob := default (dict) $restic.initJob -}}
{{ include "library-app-chart.restic.cronJob" (dict "root" . "job" $initJob) }}

# External Secrets Manager SubPathSecret for Restic
{{- /* Expose only the External Secrets inputs we need for restic backups */}}
{{- $clusterName := default .Release.Namespace .Values.clusterName }}
{{- $subPathSecret := dict "name" $secretName "remoteRefKey" (printf "/k8s-%s/restic-backup" $clusterName) }}
{{- $externalValues := deepCopy .Values }}
{{- $_ := set $externalValues "SubPathSecrets" (list $subPathSecret) }}
{{- include "external-secret-manager.subpath" (dict "Values" $externalValues "Release" .Release "Chart" .Chart "Capabilities" .Capabilities) -}}

{{- end }}
